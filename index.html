<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>오늘의 묵상</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        :root {
            --bg-color: #f4f1ea; /* 따뜻한 크림색 배경 */
            --card-bg: #ffffff;
            --text-main: #3d3d3d;
            --text-sub: #666;
            --accent-color: #967e76; /* 부드러운 갈색 */
            --card-border: 1px solid #e0dcd5;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: 'Pretendard', sans-serif;
            min-height: 100dvh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: var(--bg-color);
        }

        /* 인사 영역 */
        .header-area { position: relative; z-index: 10; text-align: center; margin: 30px 0 20px; padding: 0 20px; width: 100%; }
        .greeting-sub { font-size: 0.9rem; color: var(--accent-color); margin-bottom: 8px; font-weight: 500; letter-spacing: 1px; }
        .greeting-main { font-family: 'Gowun Batang', serif; font-size: 1.5rem; color: var(--text-main); line-height: 1.3; font-weight: 700; }
        .user-name-highlight { color: var(--accent-color); border-bottom: 2px solid rgba(150, 126, 118, 0.3); }

        /* 카드 영역 */
        .card-wrapper { position: relative; z-index: 2; width: 90%; max-width: 380px; margin-bottom: 30px; }
        .card {
            background: var(--card-bg);
            border: var(--card-border);
            border-radius: 25px;
            padding: 35px 25px;
            box-shadow: 0 10px 30px rgba(140, 130, 120, 0.15);
            text-align: center; display: flex; flex-direction: column;
            position: relative;
        }
        
        .date-label { font-size: 0.75rem; color: #aaa; letter-spacing: 1px; margin-bottom: 25px; font-weight: 600; }
        
        /* 말씀 이미지 영역 */
        .verse-image-container {
            width: 100%;
            aspect-ratio: 1 / 1; 
            margin-bottom: 30px;
            border-radius: 15px;
            overflow: hidden;
            background-color: #f8f8f8;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        }
        .verse-img { width: 100%; height: 100%; object-fit: cover; display: block; }

        .verse-content { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; margin-bottom: 25px; }
        .verse-text { font-family: 'Gowun Batang', serif; font-size: 1.3rem; color: var(--text-main); line-height: 1.75; font-weight: 700; word-break: keep-all; white-space: pre-wrap; margin-bottom: 15px; }
        .verse-source { font-family: 'Gowun Batang', serif; font-size: 0.95rem; color: var(--accent-color); font-weight: 600; }
        
        .meaning-box { font-size: 0.95rem; color: var(--text-sub); line-height: 1.65; background-color: #faf9f7; padding: 20px; border-radius: 15px; text-align: left; border: 1px solid #eee; }

        .bottom-controls { position: relative; z-index: 10; display: flex; gap: 15px; margin-bottom: 30px; }
        .ctrl-btn { background: white; border: var(--card-border); color: var(--accent-color); padding: 12px 25px; border-radius: 50px; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 3px 10px rgba(0,0,0,0.05); font-weight: 600; }
        .ctrl-btn:hover, .ctrl-btn:active { background: var(--accent-color); color: white; transform: translateY(-2px); }

        /* [잠금 화면] */
        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(50, 40, 40, 0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; padding: 30px; transition: opacity 0.5s; }
        .lock-icon { font-size: 3rem; margin-bottom: 20px; color: rgba(255,255,255,0.8); }
        .tag-hint { margin-top: 40px; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 30px; font-size: 0.8rem; color: #ddd; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* [이름 입력 모달 스타일 수정] */
        #name-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 5000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .name-card { background: white; width: 85%; max-width: 320px; padding: 40px 30px; border-radius: 25px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.2); border: 1px solid #f0f0f0; }
        
        /* [NEW] 모달 상단 양 이미지 */
        .intro-sheep-img { width: 120px; height: auto; margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto; }
        
        .name-title { font-family:'Gowun Batang'; font-size: 1.3rem; font-weight:700; margin-bottom:25px; color: #444; line-height: 1.4; }
        .name-input { width:100%; padding:15px; border:1px solid #ddd; border-radius: 12px; text-align:center; margin-bottom:20px; font-size: 1.1rem; outline: none; background: #fafafa; }
        .name-input:focus { border-color: var(--accent-color); background: #fff; }
        .name-btn { background: var(--accent-color); color: white; border: none; padding: 15px 30px; border-radius: 30px; font-size: 1.1rem; cursor: pointer; width: 100%; font-weight: 600; transition: transform 0.1s; }
        .name-btn:active { transform: scale(0.98); }

        /* 기록함 모달 */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 100; display: none; flex-direction: column; }
        .modal-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; background: white; border-bottom: var(--card-border); }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
        .history-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: var(--card-border); }
    </style>
</head>
<body>

    <div id="lock-screen" style="display: none;">
        <div class="lock-icon"><i class="fa-solid fa-lock"></i></div>
        <div class="lock-title">화면이 잠겼습니다</div>
        <div class="lock-desc">보안을 위해 접속이 제한되었습니다.<br>키링(NFC)을 다시 태그해주세요.</div>
        <div class="tag-hint"><i class="fa-solid fa-wifi"></i> NFC 태그 대기 중...</div>
    </div>

    <div id="name-modal">
        <div class="name-card">
            <img src="images/intro_lamb.png" alt="환영합니다" class="intro-sheep-img">
            
            <div class="name-title">반갑습니다.<br>성함을 알려주세요.</div>
            <input type="text" id="user-name-input" class="name-input" placeholder="이름 입력 (최대 5글자)" maxlength="5">
            <button class="name-btn" onclick="saveUserName()">시작하기</button>
        </div>
    </div>

    <div class="header-area">
        <div class="greeting-sub" id="greeting-time">Good Morning</div>
        <div class="greeting-main" id="greeting-msg">오늘 하루도<br>평안하세요</div>
    </div>

    <div class="card-wrapper" id="capture-target">
        <div class="card">
            <div class="date-label" id="card-date">TODAY</div>
            
            <div class="verse-image-container">
                <img id="verse-img" class="verse-img" src="" alt="묵상 이미지">
            </div>

            <div class="verse-content">
                <div class="verse-text" id="verse">로딩 중...</div>
                <div class="verse-source" id="source"></div>
            </div>
            <div class="meaning-box" id="meaning"></div>
        </div>
    </div>

    <div class="bottom-controls">
        <button class="ctrl-btn" onclick="toggleHistory(true)">
            <i class="fa-solid fa-book-open"></i> 기록함
        </button>
        <button class="ctrl-btn" onclick="saveCardImage()">
            <i class="fa-solid fa-download"></i> 저장하기
        </button>
    </div>

    <div class="modal" id="history-modal">
        <div class="modal-header">
            <span class="modal-title" style="font-weight:700;">나의 묵상 기록</span>
            <button onclick="toggleHistory(false)" style="border:none; background:none; font-size:1.5rem; padding:10px;">&times;</button>
        </div>
        <div class="modal-body" id="history-list"></div>
    </div>

    <script src="data.js"></script>
    <script>
        const STORAGE_KEY_HISTORY = 'bibleHistory_v6';
        const STORAGE_KEY_TODAY = 'bibleToday_v6';
        const STORAGE_KEY_AUTH = 'bibleAuthTime';
        const STORAGE_KEY_NAME = 'bibleUserName';
        const LOCK_TIMEOUT = 60 * 1000; 

        function init() {
            // 1. 잠금 화면 체크 (개발 중엔 불편하면 앞에 // 붙여서 꺼두세요)
            // 배포할 땐 // 지워야 합니다!
            // if (checkLockStatus()) return; 

            // 2. 이름 체크 (이게 켜져 있어야 양 그림이 뜹니다!)
            checkUserName();

            // 3. 날짜 및 말씀 로딩 (이게 켜져 있어야 로딩 중...이 사라집니다!)
            setTodayDateDisplay();
            checkAndLoadVerse();

            // 4. 자동 새로고침 (잠금 타이머)
            setTimeout(() => { location.reload(); }, LOCK_TIMEOUT);
        }

        // --- (나머지 함수들은 기존과 동일하므로 그대로 두거나, 아래 내용으로 덮어씌우세요) ---

        function checkUserName() {
            const savedName = localStorage.getItem(STORAGE_KEY_NAME);
            if (!savedName) { 
                document.getElementById('name-modal').style.display = 'flex'; 
            } else { 
                setGreeting(savedName); 
            }
        }

        function saveUserName() {
            const input = document.getElementById('user-name-input');
            const name = input.value.trim();
            if (name.length > 0) {
                localStorage.setItem(STORAGE_KEY_NAME, name);
                document.getElementById('name-modal').style.display = 'none';
                setGreeting(name);
            } else { alert("이름을 입력해주세요."); }
        }

        function setGreeting(name) {
            const hour = new Date().getHours();
            const subEl = document.getElementById('greeting-time');
            const msgEl = document.getElementById('greeting-msg');
            const nameSpan = name ? `<span class="user-name-highlight">${name}님</span>, ` : '';
            let subText = "", msgText = "";
            if (hour >= 5 && hour < 11) { subText = "Morning Prayer"; msgText = `${nameSpan}새로운 하루의 시작,<br>당신의 아침을 응원해요.`; } 
            else if (hour >= 11 && hour < 17) { subText = "Afternoon Break"; msgText = `${nameSpan}분주한 일상 속,<br>잠시 쉼표를 찍어보세요.`; } 
            else if (hour >= 17 && hour < 22) { subText = "Evening Comfort"; msgText = `${nameSpan}오늘 하루 수고 많았어요.<br>이제 편안히 쉬세요.`; } 
            else { subText = "Silent Night"; msgText = `${nameSpan}고요한 밤,<br>깊은 위로가 함께하기를.`; }
            subEl.innerText = subText; msgEl.innerHTML = msgText;
        }

        function checkLockStatus() {
            const urlParams = new URLSearchParams(window.location.search);
            const authKey = urlParams.get('tag');
            const lockScreen = document.getElementById('lock-screen');
            const now = new Date().getTime();
            if (authKey === 'on') { localStorage.setItem(STORAGE_KEY_AUTH, now); lockScreen.style.display = 'none'; return false; }
            const lastAuthTime = localStorage.getItem(STORAGE_KEY_AUTH);
            if (!lastAuthTime || (now - lastAuthTime > LOCK_TIMEOUT)) { lockScreen.style.display = 'flex'; document.body.style.overflow = 'hidden'; return true; }
            return false;
        }

        function setTodayDateDisplay() {
            const today = new Date();
            document.getElementById('card-date').innerText = `${today.getFullYear()}. ${today.getMonth() + 1}. ${today.getDate()}`;
        }

        function checkAndLoadVerse() {
            const todayStr = new Date().toLocaleDateString('ko-KR');
            const savedToday = JSON.parse(localStorage.getItem(STORAGE_KEY_TODAY));
            if (savedToday && savedToday.date === todayStr) { renderVerse(savedToday.data); }
            else { pickNewDailyVerse(todayStr); }
        }

        function pickNewDailyVerse(dateStr) {
            if (!bibleData || bibleData.length === 0) return;
            const randomIdx = Math.floor(Math.random() * bibleData.length);
            const selectedData = bibleData[randomIdx];
            renderVerse(selectedData);
            localStorage.setItem(STORAGE_KEY_TODAY, JSON.stringify({ date: dateStr, data: selectedData }));
            saveToHistory(dateStr, selectedData);
        }

        function renderVerse(data) {
            document.getElementById('verse-img').src = 'images/' + data.image;
            document.getElementById('verse').innerText = data.verse;
            document.getElementById('source').innerText = data.source;
            document.getElementById('meaning').innerText = data.meaning;
        }

        function saveCardImage() {
            const target = document.getElementById('capture-target');
            const btn = document.querySelector('.bottom-controls button:nth-child(2)');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 저장 중...';
            html2canvas(target, { scale: 2, backgroundColor: null, logging: false, useCORS: true })
            .then(canvas => {
                const link = document.createElement('a');
                link.download = `묵상카드_${new Date().getTime()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                btn.innerHTML = originalHTML;
                alert("갤러리에 저장되었습니다.");
            }).catch(err => { console.error(err); btn.innerHTML = originalHTML; alert("저장에 실패했습니다."); });
        }

        function saveToHistory(dateStr, data) {
            let history = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
            if (!history.some(item => item.date === dateStr)) {
                history.unshift({ date: dateStr, verse: data.verse, source: data.source });
                if (history.length > 50) history.pop();
                localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(history));
            }
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
            const listContainer = document.getElementById('history-list');
            listContainer.innerHTML = '';
            if(history.length === 0) { listContainer.innerHTML = "<div style='text-align:center; color:#aaa; margin-top:50px;'>저장된 기록이 없습니다.</div>"; return; }
            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<div class="h-date" style="font-size:0.75rem; color:#aaa; margin-bottom:5px;">${item.date}</div><div class="h-verse" style="font-family:'Gowun Batang'; font-size:1rem; font-weight:700; margin-bottom:5px;">${item.verse.replace(/\n/g, ' ')}</div><div style="font-size:0.85rem; color:var(--accent-color);">${item.source}</div>`;
                listContainer.appendChild(div);
            });
        }

        function toggleHistory(show) {
            const modal = document.getElementById('history-modal');
            if(show) { renderHistory(); modal.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
            else { modal.style.display = 'none'; document.body.style.overflow = ''; }
        }

        // [중요 변경] window.onload 대신 이 방식을 사용하세요!
        // 이미지가 로딩 안 되어도 일단 코드를 실행해서 화면을 보여줍니다.
        document.addEventListener('DOMContentLoaded', init); 

    </script>
</body>
</html>


