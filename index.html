<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>

    <script src="data.js"></script>
    <script>
        // ============================================================
        // [1] 파이어베이스 설정
        // ============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBTphxbqw8AOc6x_OTOZN9DqeQsZ5tdA3E",
            authDomain: "holy-fb987.firebaseapp.com",
            databaseURL: "https://holy-fb987-default-rtdb.firebaseio.com",
            projectId: "holy-fb987",
            storageBucket: "holy-fb987.firebasestorage.app",
            messagingSenderId: "145438518066",
            appId: "1:145438518066:web:54590bad7303afc7b0052b",
            measurementId: "G-CGD01LLDZ8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const analytics = firebase.analytics();

        // ============================================================
        // [2] 전역 변수
        // ============================================================
        const LOCK_TIMEOUT = 60 * 1000; 
        const STORAGE_KEY_AUTH = 'bibleAuthTime';
        
        let currentUserId = null; 
        let currentUserData = { name: "", history: [], today: null };

        // ============================================================
        // [3] 초기화 및 보안 검사 (핵심 변경!)
        // ============================================================
        function init() {
            // [배포 시 잠금 기능 활성화하려면 아래 주석 해제]
            // if (checkLockStatus()) return; 

            const urlParams = new URLSearchParams(window.location.search);
            const tagId = urlParams.get('tag');

            if (tagId) {
                // 태그가 있으면 검문소로 보냅니다.
                verifyKeyAndLogin(tagId);
            } else {
                // 태그 없이 주소만 치고 들어온 경우 -> 차단
                showLockScreen("잘못된 접근입니다.<br>키링을 태그해주세요.");
            }
        }

        // [NEW] 검문소 함수: 허용된 키인지 서버에 물어봄
        function verifyKeyAndLogin(tagId) {
            const allowRef = db.ref('allowed_keys/' + tagId);
            
            allowRef.once('value').then((snapshot) => {
                const isAllowed = snapshot.val(); // true면 통과, null이면 차단
                
                if (isAllowed === true) {
                    // 1. 합격! 로그인 절차 진행
                    currentUserId = tagId;
                    console.log("인증 성공:", tagId);
                    
                    // 잠금 해제 시간 기록
                    localStorage.setItem(STORAGE_KEY_AUTH, new Date().getTime());
                    document.getElementById('lock-screen').style.display = 'none';
                    
                    // 데이터 로딩 시작
                    loadUserDataFromServer();
                    setTodayDateDisplay();
                    
                    // 1분 뒤 자동 잠금 (새로고침)
                    setTimeout(() => { location.reload(); }, LOCK_TIMEOUT);

                } else {
                    // 2. 불합격! (등록되지 않은 키)
                    console.warn("미등록 키 접속 시도:", tagId);
                    showLockScreen("등록되지 않은 키링입니다.<br>관리자에게 문의하세요.");
                }
            }).catch((error) => {
                console.error("인증 에러", error);
                showLockScreen("서버 연결에 실패했습니다.");
            });
        }

        // 잠금 화면을 강제로 띄우고 메시지를 바꾸는 함수
        function showLockScreen(message) {
            const lockScreen = document.getElementById('lock-screen');
            const desc = lockScreen.querySelector('.lock-desc');
            const hint = lockScreen.querySelector('.tag-hint');
            
            lockScreen.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // 메시지 변경
            if(desc) desc.innerHTML = message;
            if(hint) hint.style.display = 'none'; // 대기 중 메시지는 숨김
        }

        // --- 기존 서버 통신 함수들 ---
        function loadUserDataFromServer() {
            const userRef = db.ref('users/' + currentUserId);
            userRef.once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    currentUserData = data;
                    if (!currentUserData.history) currentUserData.history = [];
                    setGreeting(currentUserData.name);
                    checkAndLoadVerse(); 
                } else {
                    setTimeout(() => openModal('name-modal'), 500);
                }
            });
        }

        function saveUserDataToServer() {
            if (!currentUserId) return;
            db.ref('users/' + currentUserId).set(currentUserData)
                .then(() => { console.log("서버 저장 성공"); })
                .catch((error) => { showToast("저장 실패", "fa-times"); });
        }

        // --- 기존 기능 함수들 (변경 없음) ---
        function saveUserName() {
            const input = document.getElementById('user-name-input');
            const name = input.value.trim();
            if (name.length > 0) {
                currentUserData.name = name;
                saveUserDataToServer();
                closeModal('name-modal');
                setGreeting(name);
                checkAndLoadVerse(); 
            } else { showToast("이름을 입력해주세요.", "fa-exclamation"); }
        }

        function checkAndLoadVerse() {
            const todayStr = new Date().toLocaleDateString('ko-KR');
            if (currentUserData.today && currentUserData.today.date === todayStr) {
                currentData = currentUserData.today.data;
                renderVerse(currentData);
            } else {
                pickNewDailyVerse(todayStr);
            }
        }

        function pickNewDailyVerse(dateStr) {
            if (!bibleData || bibleData.length === 0) return;
            const randomIdx = Math.floor(Math.random() * bibleData.length);
            const selectedData = bibleData[randomIdx];
            currentData = selectedData;
            currentUserData.today = { date: dateStr, data: selectedData };
            saveToHistory(dateStr, selectedData);
            renderVerse(selectedData);
            saveUserDataToServer();
        }

        function saveToHistory(dateStr, data) {
            if (!currentUserData.history.some(item => item.date === dateStr)) {
                currentUserData.history.unshift({
                    date: dateStr, verse: data.verse, source: data.source,
                    image: data.image, meaning: data.meaning, prayer: ""
                });
                if (currentUserData.history.length > 50) currentUserData.history.pop();
            }
        }

        function savePrayer() {
            const prayerText = document.getElementById('prayer-input').value.trim();
            if (!prayerText) { showToast("내용을 입력해주세요.", "fa-exclamation"); return; }
            const todayStr = new Date().toLocaleDateString('ko-KR');
            const index = currentUserData.history.findIndex(item => item.date === todayStr);
            if (index !== -1) {
                currentUserData.history[index].prayer = prayerText;
                saveUserDataToServer();
                closeModal('prayer-modal');
                setTimeout(() => { showToast("기도가 저장되었습니다."); }, 300);
            } else { showToast("말씀을 먼저 받아주세요.", "fa-times"); }
        }

        // --- UI 및 유틸리티 함수들 ---
        function openPrayerModal() {
            const todayStr = new Date().toLocaleDateString('ko-KR');
            const todayItem = currentUserData.history.find(item => item.date === todayStr);
            const textarea = document.getElementById('prayer-input');
            textarea.value = (todayItem && todayItem.prayer) ? todayItem.prayer : "";
            openModal('prayer-modal');
        }
        function renderHistory() {
            const history = currentUserData.history || [];
            const listContainer = document.getElementById('history-list');
            listContainer.innerHTML = '';
            if(history.length === 0) { listContainer.innerHTML = "<div style='text-align:center; color:#aaa; margin-top:50px;'>아직 저장된 말씀이 없습니다.</div>"; return; }
            history.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.onclick = () => showHistoryDetail(idx);
                const prayerTag = item.prayer ? `<span class="h-tag"><i class="fa-solid fa-check"></i> 기도완료</span>` : ``;
                div.innerHTML = `<div class="h-date"><span>${item.date}</span> ${prayerTag}</div><div class="h-verse">${item.verse.split('\n')[0]}...</div><div class="h-source">${item.source}</div>`;
                listContainer.appendChild(div);
            });
        }
        function showHistoryDetail(index) {
            const item = currentUserData.history[index];
            if(!item) return;
            const contentArea = document.getElementById('detail-content-area');
            const prayerHtml = item.prayer ? `<div class="prayer-content">${item.prayer.replace(/\n/g, '<br>')}</div>` : `<div style="color:#aaa; font-size:0.9rem; text-align:center; padding:20px;">작성된 기도가 없습니다.</div>`;
            contentArea.innerHTML = `<div style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">${item.date}의 묵상</div><img src="images/${item.image}" class="detail-img"><div class="detail-text">${item.verse}</div><div class="detail-source">${item.source}</div><div class="detail-meaning">${item.meaning}</div><div class="detail-prayer-box"><span class="prayer-label"><i class="fa-solid fa-pen-nib"></i> 나의 기도</span>${prayerHtml}</div>`;
            openModal('detail-modal');
        }
        function showToast(message, icon = "fa-check") {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i class="fa-solid ${icon}"></i> <span>${message}</span>`;
            container.appendChild(toast);
            requestAnimationFrame(() => { toast.classList.add('show'); });
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => { toast.remove(); }, 300); }, 2500);
        }
        function openModal(modalId) { const modal = document.getElementById(modalId); modal.style.display = 'flex'; setTimeout(() => { modal.classList.add('show'); }, 10); document.body.style.overflow = 'hidden'; }
        function closeModal(modalId) { const modal = document.getElementById(modalId); modal.classList.remove('show'); setTimeout(() => { modal.style.display = 'none'; if(!document.querySelector('.modal-overlay.show')) { document.body.style.overflow = ''; } }, 300); }
        function closeDetailModal() { closeModal('detail-modal'); }
        function renderVerse(data) { document.getElementById('verse-img').src = 'images/' + data.image; document.getElementById('verse').innerText = data.verse; document.getElementById('source').innerText = data.source; document.getElementById('meaning').innerText = data.meaning; }
        async function shareCardImage() { const target = document.getElementById('capture-target'); const btn = document.querySelector('.bottom-controls button:nth-child(2)'); const originalHTML = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 생성 중...'; try { const canvas = await html2canvas(target, { scale: 2, backgroundColor: null, useCORS: true }); canvas.toBlob(async (blob) => { if (!blob) { showToast("오류 발생", "fa-times"); btn.innerHTML = originalHTML; return; } const file = new File([blob], "daily_verse.png", { type: "image/png" }); if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) { try { await navigator.share({ files: [file], title: '오늘의 묵상', text: '오늘 저에게 주신 말씀이에요.' }); } catch (err) {} } else { showToast("공유 미지원 브라우저입니다.", "fa-times"); } btn.innerHTML = originalHTML; }); } catch (err) { console.error(err); btn.innerHTML = originalHTML; showToast("오류가 발생했습니다.", "fa-times"); } }
        function getGreetingMessage(timeSlot, nameSpan) { const messages = { morning: [`${nameSpan}새로운 하루의 시작,\n당신의 아침을 응원해요.`, `${nameSpan}오늘도 주님 안에서\n기쁨 가득한 하루 되세요.`, `${nameSpan}상쾌한 아침,\n감사로 시작해 볼까요?`], afternoon: [`${nameSpan}분주한 일상 속,\n잠시 쉼표를 찍어보세요.`, `${nameSpan}나른한 오후,\n말씀으로 힘을 얻으세요.`, `${nameSpan}점심 맛있게 드셨나요?\n오후도 화이팅!`], evening: [`${nameSpan}오늘 하루 수고 많았어요.\n이제 편안히 쉬세요.`, `${nameSpan}지친 하루의 끝,\n주님의 위로가 함께하길.`, `${nameSpan}오늘도 잘 버텨주어\n고마워요.`], night: [`${nameSpan}고요한 밤,\n깊은 위로가 함께하기를.`, `${nameSpan}내일의 걱정은 맡기고\n편안히 주무세요.`, `${nameSpan}오늘 하루도\n당신은 충분히 잘했어요.`] }; const msgList = messages[timeSlot]; const todayDate = new Date().getDate(); return msgList[todayDate % msgList.length]; }
        function setGreeting(name) { const hour = new Date().getHours(); const subEl = document.getElementById('greeting-time'); const msgEl = document.getElementById('greeting-msg'); const nameSpan = name ? `<span class="user-name-highlight">${name}님</span>, ` : ''; let timeSlot = ""; let subText = ""; if (hour >= 5 && hour < 11) { subText = "Morning Prayer"; timeSlot = "morning"; } else if (hour >= 11 && hour < 17) { subText = "Afternoon Break"; timeSlot = "afternoon"; } else if (hour >= 17 && hour < 22) { subText = "Evening Comfort"; timeSlot = "evening"; } else { subText = "Silent Night"; timeSlot = "night"; } subEl.innerText = subText; msgEl.innerHTML = getGreetingMessage(timeSlot, nameSpan); }
        function checkLockStatus() { const urlParams = new URLSearchParams(window.location.search); const authKey = urlParams.get('tag'); const lockScreen = document.getElementById('lock-screen'); const now = new Date().getTime(); if (authKey) { localStorage.setItem(STORAGE_KEY_AUTH, now); lockScreen.style.display = 'none'; return false; } const lastAuthTime = localStorage.getItem(STORAGE_KEY_AUTH); if (!lastAuthTime || (now - lastAuthTime > LOCK_TIMEOUT)) { lockScreen.style.display = 'flex'; document.body.style.overflow = 'hidden'; return true; } return false; }
        function setTodayDateDisplay() { const today = new Date(); document.getElementById('card-date').innerText = `${today.getFullYear()}. ${today.getMonth() + 1}. ${today.getDate()}`; }

        document.addEventListener('DOMContentLoaded', init);
    </script>
